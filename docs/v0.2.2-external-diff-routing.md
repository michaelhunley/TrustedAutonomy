# v0.2.2 — External Diff Routing

**Status**: ✅ Implemented

## Overview

External diff routing enables custom viewing applications for different file types. Instead of showing binary or specialized files as inline diffs, `ta pr view` can open them in configured external applications (Unreal Editor, Blender, image viewers, etc.) or fall back to OS defaults.

## Features

- **Pattern-based routing**: Map file patterns (glob syntax) to external applications
- **OS integration**: Falls back to `open` (macOS) / `xdg-open` (Linux) / `start` (Windows) when no handler is configured
- **Flexible configuration**: TOML config with argument templates and descriptions
- **Opt-in/opt-out**: `--open-external` / `--no-open-external` flags for inline vs external viewing

## Configuration

Create `.ta/diff-handlers.toml` in your project root:

```toml
# Unreal Engine assets
[[handler]]
pattern = "*.uasset"
command = "UnrealEditor"
args = ["{file}"]
description = "Unreal Engine asset file"

# Image files (macOS example)
[[handler]]
pattern = "*.png"
command = "open"
args = ["-a", "Preview", "{file}"]
description = "PNG image"

# Blender files
[[handler]]
pattern = "*.blend"
command = "blender"
args = ["{file}"]
description = "Blender 3D scene file"

# Deep paths (Unity)
[[handler]]
pattern = "Assets/**/*.unity"
command = "Unity"
args = ["-projectPath", ".", "-openFile", "{file}"]
description = "Unity scene file"
```

### Pattern Syntax

- `*` — matches any characters except `/` (single directory level)
- `**` — matches any characters including `/` (deep paths)
- No brace expansion `{a,b,c}` — create separate handler rules for multiple extensions

### Placeholder

- `{file}` — replaced with the absolute path to the staged file

## Usage

### View PR with external handlers (default)

```bash
ta pr view <pr-id> --file path/to/model.uasset
# Opens in UnrealEditor if configured, else OS default
```

### Force inline diff display

```bash
ta pr view <pr-id> --file path/to/image.png --no-open-external
# Shows [binary: 1.2 MB] instead of opening Preview
```

### View all changes inline

```bash
ta pr view <pr-id>
# Shows inline diffs for all files (--file not specified)
```

## Behavior

1. **When `--file` is specified with a single file**:
   - If `--open-external` is true (default), try configured handler → OS default → inline diff
   - If `--no-open-external`, show inline diff
2. **When viewing all files** (no `--file`):
   - Always show inline diffs for all files
3. **Binary files without handlers**:
   - Show byte count summary: `[binary: 1.2 MB]`
4. **Command not found**:
   - Print error and fall back to inline diff

## Architecture

### New Module: `ta-changeset::diff_handlers`

- **`DiffHandlersConfig`** — TOML config schema and loader
- **`HandlerRule`** — Single pattern-to-command mapping
- **`open_file()`** — Launch handler or OS default
- **Pattern matching** — Uses `glob` crate for file path matching

### CLI Integration

- **`ta pr view --file <path>`** — Loads config, matches pattern, launches handler
- **`--open-external`** flag — Controls external vs inline viewing (default: true)

### Error Handling

- Missing config → empty config (all files use OS default or inline)
- Invalid TOML → parse error reported to user
- Command not found → error message + fallback to inline diff
- OS default not supported → error (rare, covers most platforms)

## Testing

### Unit Tests (ta-changeset)

- `test_pattern_matching` — glob syntax validation
- `test_load_config_*` — TOML parsing and missing file fallback
- `test_find_handler` — pattern matching logic
- `test_arg_substitution` — `{file}` placeholder replacement

### Integration Tests (ta-cli)

- Manual testing required for actual command launching (system-dependent)
- Existing PR view tests continue to pass with new parameter

## Limitations

1. **Brace expansion not supported**: The `glob` crate doesn't support `{png,jpg}` syntax. Create separate rules for each extension.
2. **No handler chaining**: Only the first matching handler is used.
3. **No async launch**: Commands are launched synchronously (`spawn()` doesn't wait for completion).
4. **Platform-specific defaults**: OS default launcher logic is platform-specific.

## Future Enhancements (not in v0.2.2)

- **Handler chaining**: Preprocess with tool A, then open in tool B
- **Async launch tracking**: Monitor launched processes and capture exit codes
- **Handler validation**: Check if commands exist before attempting launch
- **Interactive handler selection**: Prompt user to choose from multiple matching handlers
- **Remote file support**: Handle non-`fs://` URIs (requires connector integration)

## Example Use Cases

### Game Development (Unreal Engine)

```toml
[[handler]]
pattern = "Content/**/*.uasset"
command = "UnrealEditor"
args = ["-game", "MyProject", "{file}"]
description = "Unreal asset"
```

### 3D Art Pipeline (Blender)

```toml
[[handler]]
pattern = "assets/**/*.blend"
command = "blender"
args = ["--background", "{file}", "--python", "scripts/diff_render.py"]
description = "Blender file with render script"
```

### Document Review (macOS)

```toml
[[handler]]
pattern = "docs/**/*.pdf"
command = "open"
args = ["-a", "Skim", "{file}"]
description = "PDF with annotations"
```

### Audio Editing

```toml
[[handler]]
pattern = "*.{wav,aiff}"  # Note: brace expansion NOT supported
command = "open"
args = ["-a", "Audacity", "{file}"]
description = "Audio file"
```

## Changelog

- **Added**: `ta-changeset::diff_handlers` module with TOML config, pattern matching, and OS integration
- **Added**: `--open-external` / `--no-open-external` flags to `ta pr view --file`
- **Added**: `.ta/diff-handlers.example.toml` with common handler examples
- **Changed**: `ta pr view --file <path>` now opens in external handler by default
- **Dependency**: Added `toml = "0.8"` to `ta-changeset`

## Related

- **Phase v0.2.0** — Submit adapters (git workflow integration)
- **Phase v0.2.1** — Conflict detection (stale overlay warnings)
- **Phase v0.2.3** — Tiered diff explanations (planned)
